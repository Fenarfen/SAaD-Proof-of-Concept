@page "/signin"
@using System.Text.Json;
@using System.Net.Http.Json
@using System.Text.RegularExpressions;
@inject AMLWebAplication.Services.HttpClientService HttpClientService
@inject NavigationManager Navigation
@inject Blazored.SessionStorage.ISessionStorageService SessionStorage

<h3>Sign In</h3>

<div>
    <label for="email">Email:</label>
    <input id="email" type="email" @bind="email" />
</div>
<div>
    <label for="password">Password:</label>
    <input id="password" type="password" @bind="password" />
</div>
<p>@GeneralError</p>
<button @onclick="AttemptSignIn">Sign In</button>

<p>@statusMessage</p>

@code {
    private string email;
    private string password;
    private string statusMessage;
    private string GeneralError;

    private async Task AttemptSignIn()
    {
        try
        {
            HttpClient authAPI = HttpClientService.GetAuthHttpClient();

            var apiEndpoint = "auth/login";

            var response = await authAPI.PostAsJsonAsync(apiEndpoint, new { email = email, password = password });

            if (!response.IsSuccessStatusCode)
            {
                string errorBody = await response.Content.ReadAsStringAsync();
                GeneralError = "Log in attempt failed. Email or password incorrect.\n\n" + errorBody;
            }
            else
            {
                var jsonResponse = await response.Content.ReadAsStringAsync();
                var loginResponse = JsonSerializer.Deserialize<LoginResponse>(jsonResponse);

                Console.WriteLine("signin - token " + loginResponse.token);
                Console.WriteLine("signin - role " + loginResponse.role);
                await SessionStorage.SetItemAsync("token", loginResponse.token);
                await SessionStorage.SetItemAsync("role", loginResponse.role);

                Navigation.NavigateTo("/");
            }
        }
        catch (Exception ex)
        {
            statusMessage = "Something went wrong, please try again.\n\n" + ex.ToString();
        }
    }

    class LoginResponse
    {
        public string token { get; set; }
        public string role { get; set; }
    }
}